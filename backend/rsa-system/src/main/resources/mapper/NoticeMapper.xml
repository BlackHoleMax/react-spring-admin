<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="dev.illichitcat.system.dao.mapper.NoticeMapper">
    <!-- 分页查询通知公告列表 -->
    <select id="selectNoticePage" resultType="dev.illichitcat.system.model.vo.NoticeVO">
        SELECT
        n.id,
        n.title,
        n.content,
        n.type,
        n.target_type AS targetType,
        n.target_roles AS targetRoles,
        n.priority,
        n.start_time AS startTime,
        n.end_time AS endTime,
        n.status,
        n.publish_time AS publishTime,
        n.publisher_id AS publisherId,
        n.publisher_name AS publisherName,
        n.read_count AS readCount,
        n.total_count AS totalCount,
        n.create_time AS createTime,
        n.update_time AS updateTime
        FROM sys_notice n
        WHERE n.del_flag = 0
        <if test="query.title != null and query.title.trim() != ''">
            AND n.title LIKE CONCAT('%', #{query.title}, '%')
        </if>
        <if test="query.type != null">
            AND n.type = #{query.type}
        </if>
        <if test="query.status != null">
            AND n.status = #{query.status}
        </if>
        <if test="query.priority != null">
            AND n.priority = #{query.priority}
        </if>
        ORDER BY n.create_time DESC
    </select>

    <!-- 查询我的通知列表 -->
    <select id="selectMyNoticePage" resultType="dev.illichitcat.system.model.vo.NoticeVO">
        SELECT
        n.id,
        n.title,
        n.content,
        n.type,
        n.target_type AS targetType,
        n.priority,
        n.start_time AS startTime,
        n.end_time AS endTime,
        n.status,
        n.publish_time AS publishTime,
        n.publisher_name AS publisherName,
        n.read_count AS readCount,
        n.total_count AS totalCount,
        n.create_time AS createTime,
        CASE WHEN nr.id IS NOT NULL THEN 1 ELSE 0 END AS readStatus
        FROM sys_notice n
        LEFT JOIN sys_notice_read nr ON n.id = nr.notice_id AND nr.user_id = #{userId}
        WHERE n.del_flag = 0
        AND n.status = 2
        AND (n.start_time IS NULL OR n.start_time &lt;= NOW())
        AND (n.end_time IS NULL OR n.end_time &gt;= NOW())
        AND (
        n.target_type = 1
        OR n.target_type = 2 AND EXISTS (
        SELECT 1 FROM sys_user_role ur
        WHERE ur.user_id = #{userId}
        AND JSON_CONTAINS(n.target_roles, JSON_ARRAY(ur.role_id))
        )
        )
        <if test="query.title != null and query.title.trim() != ''">
            AND n.title LIKE CONCAT('%', #{query.title}, '%')
        </if>
        <if test="query.type != null">
            AND n.type = #{query.type}
        </if>
        <if test="query.readStatus != null">
            <if test="query.readStatus == 1">
                AND nr.id IS NOT NULL
            </if>
            <if test="query.readStatus == 0">
                AND nr.id IS NULL
            </if>
        </if>
        ORDER BY n.publish_time DESC
    </select>

    <!-- 获取未读通知数量 -->
    <select id="selectUnreadCount" resultType="java.lang.Long">
        SELECT COUNT(*)
        FROM sys_notice n
                 LEFT JOIN sys_notice_read nr ON n.id = nr.notice_id AND nr.user_id = #{userId}
        WHERE n.del_flag = 0
          AND n.status = 2
          AND nr.id IS NULL
          AND (n.start_time IS NULL OR n.start_time &lt;= NOW())
          AND (n.end_time IS NULL OR n.end_time &gt;= NOW())
          AND (
            n.target_type = 1
                OR n.target_type = 2 AND EXISTS (SELECT 1
                                                 FROM sys_user_role ur
                                                 WHERE ur.user_id = #{userId}
                                                   AND JSON_CONTAINS(n.target_roles, JSON_ARRAY(ur.role_id)))
            )
    </select>

    <!-- 批量查询通知已读状态 -->
    <select id="selectReadNoticeIds" resultType="java.lang.Long">
        SELECT notice_id
        FROM sys_notice_read
        WHERE user_id = #{userId}
        AND notice_id IN
        <foreach collection="noticeIds" item="id" open="(" separator="," close=")">
            #{id}
        </foreach>
    </select>
</mapper>