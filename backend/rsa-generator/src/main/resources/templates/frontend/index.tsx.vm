import React, {useCallback, useEffect, useState} from 'react';
import {
    App,
    Button,
    Card,
    Checkbox,
    Col,
    DatePicker,
    Form,
    Input,
    Modal,
    Popconfirm,
    Radio,
    Row,
    Select,
    Space,
    Table,
    Typography,
    Upload,
} from 'antd';
import Authorized from '@/components/Authorized';
import {
    DeleteOutlined,
    DownloadOutlined,
    EditOutlined,
    ExportOutlined,
    ImportOutlined,
    PlusOutlined,
    ReloadOutlined,
    UploadOutlined,
} from '@ant-design/icons';
import {
    create${table.className},
    delete${table.className},
    export${table.className},
    import${table.className},
    update${table.className}
} from '@/services/';
import {getDictOptions} from '@/utils/dict';
import dayjs from 'dayjs';

const {Text} = Typography;

const ${table.className}Management: React.FC = () => {
    const {message} = App.useApp();
    const [data, setData] = useState<${table.className}[]>([]);
    const [loading, setLoading] = useState(false);
    const [modalVisible, setModalVisible] = useState(false);
    const [importModalVisible, setImportModalVisible] = useState(false);
    const [importFileList, setImportFileList] = useState<any[]>([]);
    const [importing, setImporting] = useState(false);
    const [editing${table.className}, setEditing${table.className}] = useState<${table.className} | null>(null);
    const [selectedRowKeys, setSelectedRowKeys] = useState<React.Key[]>([]);
    const [form] = Form.useForm();
    const [dictOptions, setDictOptions] = useState<Record<string, any[]>>({});

    const fetchData = useCallback(async () => {
        setLoading(true);
        try {
            const result = await get${table.className}List();
            setData(result);
        } catch {
            message.error('获取数据失败');
        } finally {
            setLoading(false);
        }
    }, [message]);

    useEffect(() => {
        fetchData();
        // 加载字典选项
        #foreach($column in $columns)
            #if($column.dictType && $column.dictType != '')
                getDictOptions('${column.dictType}').then(options => {
                    setDictOptions(prev => ({...prev, '${column.javaField}': options}));
                });
            #end
        #end
    }, [fetchData]);

    const handleAdd = async () => {
        setEditing${table.className}(null);
        form.resetFields();
        setModalVisible(true);
    };

    const handleEdit = (record: ${table.className}) => {
        setEditing${table.className}(record);
        form.setFieldsValue(record);
        setModalVisible(true);
    };

    const handleDelete = async (id: number) => {
        try {
            await delete${table.className}(id);
            message.success('删除成功');
            await fetchData();
        } catch {
            message.error('删除失败');
        }
    };

    const handleSubmit = async () => {
        try {
            const values = await form.validateFields();

            if (editing${table.className}) {
                await update${table.className}({...values, id: editing${table.className}.id});
                message.success('更新成功');
            } else {
                await create${table.className}(values);
                message.success('创建成功');
            }

            setModalVisible(false);
            await fetchData();
        } catch {
            message.error('操作失败');
        }
    };

    const handleExport = async () => {
        try {
            const ids = selectedRowKeys.length > 0 ? selectedRowKeys as number[] : undefined;
            const blob = await export${table.className}(ids);
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = '${table.tableComment}_' + dayjs().format('YYYYMMDD_HHmmss') + '.xlsx';
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(url);
            document.body.removeChild(a);
            message.success('导出成功');
        } catch {
            message.error('导出失败');
        }
    };

    const handleDownloadTemplate = async () => {
        try {
            const blob = await download${table.className}Template();
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = '${table.tableComment}导入模板.xlsx';
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(url);
            document.body.removeChild(a);
            message.success('模板下载成功');
        } catch {
            message.error('模板下载失败');
        }
    };

    const handleImport = async () => {
        if (importFileList.length === 0) {
            message.warning('请选择要导入的文件');
            return;
        }

        setImporting(true);
        try {
            const result = await import${table.className}(importFileList[0].originFileObj);
            message.success(result || '导入成功');
            setImportModalVisible(false);
            setImportFileList([]);
            await fetchData();
        } catch (error: any) {
            message.error(error.message || '导入失败');
        } finally {
            setImporting(false);
        }
    };

    const handleImportCancel = () => {
        setImportModalVisible(false);
        setImportFileList([]);
    };

    const columns = [
        #foreach($column in $columns)
            #if($column.isList == '1')
                {
                    title: '${column.columnComment}',
                    dataIndex: '${column.javaField}',
                    key: '${column.javaField}',
                    #if($column.javaType == 'LocalDateTime')
                        render: (text: string | number | Date | dayjs.Dayjs | null | undefined) => {
                            return dayjs(text).format('YYYY-MM-DD HH:mm:ss');
                        },
                    #elseif($column.dictType && $column.dictType != '')
                        render: (text: string | number | null | undefined) => {
                            const options = dictOptions['${column.javaField}'] || [];
                            const option = options.find((opt: any) => opt.value === String(text));
                            return option ? option.label : text;
                        },
                    #end
                },
            #end
        #end
        {
            title: '操作',
            key: 'action',
            width: 200,
            render: (_: unknown, record: ${table.className}) => (
                <Space>
                    <Authorized permission="${table.className}:edit">
                        <Button type="link" icon={<EditOutlined/>} onClick={() => handleEdit(record)}>
                            编辑
                        </Button>
                    </Authorized>
                    <Authorized permission="${table.className}:delete">
                        <Popconfirm title="确定删除?" onConfirm={() => handleDelete(record.id)}>
                            <Button type="link" danger icon={<DeleteOutlined/>}>
                                删除
                            </Button>
                        </Popconfirm>
                    </Authorized>
                </Space>
            ),
        },
    ];

    return (
        <div>
            <Card>
                <div
                    style={{
                        marginBottom: '16px',
                        display: 'flex',
                        justifyContent: 'space-between',
                        alignItems: 'center',
                    }}
                >
                    <h2 style={{fontSize: '20px', fontWeight: 'bold', margin: 0}}>${table.tableComment}</h2>
                    <Space>
                        <Button icon={<ReloadOutlined/>} onClick={fetchData}>
                            刷新
                        </Button>
                        <Authorized permission="${table.className}:import">
                            <Button icon={<ImportOutlined/>} onClick={() => setImportModalVisible(true)}>
                                导入
                            </Button>
                        </Authorized>
                        <Authorized permission="${table.className}:export">
                            <Button icon={<ExportOutlined/>} onClick={handleExport}>
                                导出
                            </Button>
                        </Authorized>
                        <Authorized permission="${table.className}:add">
                            <Button type="primary" icon={<PlusOutlined/>} onClick={handleAdd}>
                                新增
                            </Button>
                        </Authorized>
                    </Space>
                </div>
                <Table
                    columns={columns}
                    dataSource={data}
                    rowKey="id"
                    loading={loading}
                    rowSelection={{
                        selectedRowKeys,
                        onChange: setSelectedRowKeys,
                    }}
                />
            </Card>
            #if($table.formLayout == '1')
                #set($modalWidth = 600)
            #elseif($table.formLayout == '2')
                #set($modalWidth = 800)
            #elseif($table.formLayout == '3')
                #set($modalWidth = 1200)
            #else
                #set($modalWidth = 600)
            #end
            <Modal
                title={editing${table.className} ? '编辑${table.tableComment}' : '新增${table.tableComment}'}
                open={modalVisible}
                onOk={handleSubmit}
                onCancel={() => setModalVisible(false)}
                width={$modalWidth}
            >
            <Form form={form} layout="vertical">
                #set($editColumns = [])
                #foreach($column in $columns)
                    #if($column.isEdit == '1')
                        #set($added = $editColumns.add($column))
                    #end
                #end
                #if($table.formLayout == '1')
                    #foreach($column in $editColumns)
                        #if($column.isRequired == '1')
                            #set($isRequired = true)
                        #else
                            #set($isRequired = false)
                        #end
                        <Form.Item name='${column.javaField}' label='${column.columnComment}'
                                   rules={[{required: $isRequired}]}>
                            #if($column.htmlType == 'textarea')
                                <Input.TextArea rows={4}/>
                            #elseif($column.htmlType == 'select')
                                #if($column.dictType && $column.dictType != '')
                                    <Select placeholder="请选择${column.columnComment}"
                                            options={dictOptions['${column.javaField}'] || []}/>
                                #else
                                    <Select placeholder="请选择${column.columnComment}" options={[]}/>
                                #end
                            #elseif($column.htmlType == 'radio')
                                <Radio.Group>
                                    <Radio value="1">选项1</Radio>
                                    <Radio value="2">选项2</Radio>
                                </Radio.Group>
                            #elseif($column.htmlType == 'checkbox')
                                <Checkbox.Group>
                                    <Checkbox value="1">选项1</Checkbox>
                                    <Checkbox value="2">选项2</Checkbox>
                                </Checkbox.Group>
                            #elseif($column.htmlType == 'datetime')
                                <DatePicker showTime style={{width: '100%'}}/>
                            #elseif($column.htmlType == 'imageUpload')
                                <Upload listType="picture-card">
                                    <PlusOutlined/>
                                </Upload>
                            #elseif($column.htmlType == 'fileUpload')
                                <Upload>
                                    <Button icon={<UploadOutlined/>}>上传文件</Button>
                                </Upload>
                            #elseif($column.htmlType == 'editor')
                                <Input.TextArea rows={6}/>
                            #else
                                <Input placeholder="请输入${column.columnComment}"/>
                            #end
                        </Form.Item>
                    #end
                #else
                    #set($colSpan = 24)
                    #if($table.formLayout == '2')
                        #set($colSpan = 12)
                    #elseif($table.formLayout == '3')
                        #set($colSpan = 8)
                    #end
                    #set($rowCount = 0)
                    #if($table.formLayout == '2')
                        #set($columnsPerRow = 2)
                    #elseif($table.formLayout == '3')
                        #set($columnsPerRow = 3)
                    #else
                        #set($columnsPerRow = 1)
                    #end
                    #foreach($column in $editColumns)
                        #if($rowCount % $columnsPerRow == 0)
                        <Row gutter={16}>
                        #end
                        <Col span={$colSpan}>
                            #if($column.isRequired == '1')
                                #set($isRequired = true)
                            #else
                                #set($isRequired = false)
                            #end
                            <Form.Item name='${column.javaField}' label='${column.columnComment}'
                                       rules={[{required: $isRequired}]}>
                                #if($column.htmlType == 'textarea')
                                    <Input.TextArea rows={4}/>
                                #elseif($column.htmlType == 'select')
                                    #if($column.dictType && $column.dictType != '')
                                        <Select placeholder="请选择${column.columnComment}"
                                                options={dictOptions['${column.javaField}'] || []}/>
                                    #else
                                        <Select placeholder="请选择${column.columnComment}" options={[]}/>
                                    #end
                                #elseif($column.htmlType == 'radio')
                                    <Radio.Group>
                                        <Radio value="1">选项1</Radio>
                                        <Radio value="2">选项2</Radio>
                                    </Radio.Group>
                                #elseif($column.htmlType == 'checkbox')
                                    <Checkbox.Group>
                                        <Checkbox value="1">选项1</Checkbox>
                                        <Checkbox value="2">选项2</Checkbox>
                                    </Checkbox.Group>
                                #elseif($column.htmlType == 'datetime')
                                    <DatePicker showTime style={{width: '100%'}}/>
                                #elseif($column.htmlType == 'imageUpload')
                                    <Upload listType="picture-card">
                                        <PlusOutlined/>
                                    </Upload>
                                #elseif($column.htmlType == 'fileUpload')
                                    <Upload>
                                        <Button icon={<UploadOutlined/>}>上传文件</Button>
                                    </Upload>
                                #elseif($column.htmlType == 'editor')
                                    <Input.TextArea rows={6}/>
                                #else
                                    <Input placeholder="请输入${column.columnComment}"/>
                                #end
                            </Form.Item>
                        </Col>
                        #set($rowCount = $rowCount + 1)
                        #if($rowCount % $columnsPerRow == 0)
                        </Row>
                        #end
                    #end
                    #if($rowCount % $columnsPerRow != 0)
                    </Row>
                    #end
                #end
            </Form>
        </Modal>

    {/* 导入模态框 */
    }
    <Modal
        title='导入${table.tableComment}'
        open={importModalVisible}
        onOk={handleImport}
        onCancel={handleImportCancel}
        confirmLoading={importing}
        width={600}
    >
        <div style={{marginBottom: 16}}>
            <Button
                type="link"
                icon={<DownloadOutlined/>}
                onClick={handleDownloadTemplate}
            >
                下载导入模板
            </Button>
        </div>
        <div style={{marginBottom: 16}}>
            <Text type="secondary">
                请先下载模板，按照模板格式填写数据后再上传。支持 .xlsx 格式文件。
            </Text>
        </div>
        <Upload
            fileList={importFileList}
            onChange={({fileList}) => setImportFileList(fileList)}
            beforeUpload={() => false}
            maxCount={1}
            accept=".xlsx,.xls"
        >
            <Button icon={<UploadOutlined/>}>选择文件</Button>
        </Upload>
    </Modal>
</div>
)
    ;
};

export default ${table.className}Management;